# çƒ­åŠ›æ—¥å†æ•°æ®åŠ è½½ä¼˜åŒ–æŠ¥å‘Š

## ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–é’ˆå¯¹çƒ­åŠ›æ—¥å†åŠŸèƒ½çš„æ•°æ®åŠ è½½æµç¨‹å’Œå“åº”å¼æ›´æ–°æœºåˆ¶è¿›è¡Œäº†å…¨é¢æ”¹è¿›ï¼Œä¸»è¦è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ€§èƒ½é—®é¢˜**ï¼šå­˜åœ¨ä¸å¿…è¦çš„ `Map â†’ Array â†’ Map` æ•°æ®ç»“æ„è½¬æ¢
2. **å“åº”å¼é—®é¢˜**ï¼šé˜…è¯»è®°å½•æ›´æ–°åçƒ­åŠ›æ—¥å†é¢œè‰²ä¸åˆ·æ–°
3. **ä»£ç è´¨é‡é—®é¢˜**ï¼šå­˜åœ¨è¯­æ³•é”™è¯¯å’Œå†—ä½™ä»£ç 

## é—®é¢˜åˆ†æ

### 1. æ•°æ®æµè½¬é—®é¢˜

**åŸæœ‰æ•°æ®æµç¨‹ï¼š**
```
æ•°æ®åº“ (Map<string, DailyReadingStats>)
  â†“
getDailyStatsInRange() è½¬æ¢ä¸ºæ•°ç»„
  â†“
Array<DailyReadingStats>
  â†“
UI å±‚å†æ¬¡è½¬æ¢ä¸º Map<string, number>
  â†“
æ¸²æŸ“ä½¿ç”¨
```

**é—®é¢˜ç‚¹ï¼š**
- ä¸­é—´å±‚ä¸å¿…è¦çš„æ•°ç»„è½¬æ¢ï¼Œå¢åŠ å†…å­˜å¼€é”€
- æ•°æ®æ‹·è´æ¬¡æ•°è¿‡å¤šï¼Œå½±å“æ€§èƒ½
- é€»è¾‘å¤æ‚ï¼Œç»´æŠ¤æˆæœ¬é«˜

### 2. å“åº”å¼æ›´æ–°é—®é¢˜

**ç—‡çŠ¶ï¼š**
- ç‚¹å‡»æ–‡ç« å¢åŠ é˜…è¯»é‡åï¼Œä¸»é¡µé¢çƒ­åŠ›æ—¥å†é¢œè‰²ä¿æŒé»‘è‰²
- æ‰“å¼€å…¨å±æ¨¡å¼åé¢œè‰²æ­£ç¡®æ˜¾ç¤º
- å…³é—­å…¨å±æ¨¡å¼ååˆæ¢å¤ä¸ºé»‘è‰²

**æ ¹æœ¬åŸå› ï¼š**
1. `@Local` è£…é¥°çš„ Map å†…éƒ¨å˜åŒ–ï¼ˆset/deleteï¼‰ä¸ä¼šè§¦å‘ UI æ›´æ–°
2. ForEach çš„ key ç”Ÿæˆé€»è¾‘æœªåŒ…å«èƒ½åæ˜ æ•°æ®å˜åŒ–çš„æ ‡è¯†
3. ä¸»é¡µé¢å’Œå…¨å±æ¨¡å¼çš„ key ç”Ÿæˆé€»è¾‘ä¸ä¸€è‡´

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ–°å¢ä¼˜åŒ–æ¥å£

åœ¨ `HistoryManager` ä¸­æ–°å¢ `getDailyCountMapInRange()` æ–¹æ³•ï¼Œç›´æ¥è¿”å› `Map<string, number>`ï¼š

**æ–°å¢ä»£ç ï¼š**
```typescript
/**
 * è·å–æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„é˜…è¯»æ•°é‡ Mapï¼ˆä¼˜åŒ–ç‰ˆï¼‰
 * ç›´æ¥è¿”å› Map<dateStr, count>ï¼Œé¿å…ä¸å¿…è¦çš„æ•°ç»„è½¬æ¢
 * 
 * @param days - å¤©æ•°èŒƒå›´
 * @returns æ—¥æœŸåˆ°é˜…è¯»æ•°é‡çš„ Map
 */
async getDailyCountMapInRange(days: number): Promise<Map<string, number>> {
  const statsMap = await this.getDailyStatsMap()
  const result = new Map<string, number>()
  const today = new Date()

  for (let i = 0; i < days; i++) {
    const date = new Date(today)
    date.setDate(today.getDate() - i)
    const dateStr = this.formatDate(date)
    
    const stats = statsMap.get(dateStr)
    if (stats && stats.count > 0) {
      result.set(dateStr, stats.count)
    }
  }

  return result
}
```

**ä¼˜åŠ¿ï¼š**
- ç›´æ¥è¿”å› UI å±‚éœ€è¦çš„æ•°æ®ç»“æ„
- åªåŒ…å«æœ‰é˜…è¯»è®°å½•çš„æ—¥æœŸï¼Œå‡å°‘å†…å­˜å ç”¨
- é¿å…ä¸­é—´æ•°ç»„çš„åˆ›å»ºå’Œéå†

### 2. ä¼˜åŒ– UI å±‚æ•°æ®åŠ è½½

#### 2.1 ç§»é™¤å†—ä½™çŠ¶æ€å˜é‡

**ä¼˜åŒ–å‰ï¼š**
```typescript
@Local dailyStats: DailyReadingStats[] = []
@Local statsMap: Map<string, number> = new Map()
```

**ä¼˜åŒ–åï¼š**
```typescript
// ä¼˜åŒ–ï¼šç›´æ¥ä½¿ç”¨ Map å­˜å‚¨é˜…è¯»æ•°é‡ï¼Œé¿å…æ•°ç»„è½¬æ¢
@Local statsMap: Map<string, number> = new Map()
```

#### 2.2 ç®€åŒ–æ•°æ®åŠ è½½é€»è¾‘

**ä¼˜åŒ–å‰ï¼š**
```typescript
async loadDailyStats(): Promise<void> {
  this.isLoading = true
  try {
    // åŠ è½½365å¤©çš„æ•°æ®ç”¨äºæœˆå†æ˜¾ç¤º
    this.dailyStats = await historyManager.getDailyStatsInRange(365)
    this.statsMap.clear()
    this.dailyStats.forEach(stat => {
      if (stat.count > 0) {
        this.statsMap.set(stat.dateStr, stat.count)
      }
    })
    this.generateHeatmapCells()
    this.totalReadCount = this.dailyStats
      .filter(stat => {
        const date = new Date(stat.dateStr)
        const today = new Date()
        const diffDays = Math.floor((today.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))
        return diffDays < this.userConfig.heatmapTimeRange
      })
      .reduce((sum, stat) => sum + stat.count, 0)
  } catch (error) {
    console.error('åŠ è½½æ¯æ—¥ç»Ÿè®¡å¤±è´¥:', JSON.stringify(error))
  } finally {
    this.isLoading = false
  }
}
```

**ä¼˜åŒ–åï¼š**
```typescript
async loadDailyStats(): Promise<void> {
  this.isLoading = true
  try {
    // ä¼˜åŒ–ï¼šç›´æ¥åŠ è½½ Mapï¼Œé¿å…æ•°ç»„è½¬æ¢
    const timeRange = this.userConfig.heatmapTimeRange
    const newStatsMap = await historyManager.getDailyCountMapInRange(365)
    
    // å¼ºåˆ¶è§¦å‘ Map æ›´æ–°ï¼ˆé‡æ–°èµ‹å€¼ä»¥è§¦å‘å“åº”å¼ï¼‰
    this.statsMap = newStatsMap
    
    this.generateHeatmapCells()
    
    // è®¡ç®—æ€»é˜…è¯»æ•°
    this.totalReadCount = 0
    const today = new Date()
    this.statsMap.forEach((count, dateStr) => {
      const date = new Date(dateStr)
      const diffDays = Math.floor((today.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))
      if (diffDays < timeRange) {
        this.totalReadCount += count
      }
    })
  } catch (error) {
    console.error('åŠ è½½æ¯æ—¥ç»Ÿè®¡å¤±è´¥:', JSON.stringify(error))
  } finally {
    this.isLoading = false
  }
}
```

**æ”¹è¿›ç‚¹ï¼š**
- ç›´æ¥è°ƒç”¨æ–°æ¥å£ï¼Œçœç•¥æ•°ç»„ä¸­é—´å±‚
- é€šè¿‡é‡æ–°èµ‹å€¼ `this.statsMap = newStatsMap` è§¦å‘å“åº”å¼æ›´æ–°
- ç®€åŒ– `totalReadCount` è®¡ç®—ï¼Œç›´æ¥éå† Map
- å‡å°‘ä»£ç è¡Œæ•°ï¼Œæå‡å¯è¯»æ€§

### 3. ä¿®å¤å“åº”å¼æ›´æ–°æœºåˆ¶

#### 3.1 å®Œå–„ç›‘å¬å™¨

**ä¼˜åŒ–å‰ï¼š**
```typescript
@Monitor('historyUpdateTrigger.trigger')
async onHistoryUpdate(): Promise<void> {
  await this.loadDailyStats()
  this.generateCalendarDays()
}
```

**ä¼˜åŒ–åï¼š**
```typescript
@Monitor('historyUpdateTrigger.trigger')
async onHistoryUpdate(): Promise<void> {
  await this.loadDailyStats()
  this.generateHeatmapCells()  // æ–°å¢ï¼šç¡®ä¿çƒ­åŠ›æ ¼å­ä¹Ÿæ›´æ–°
  this.generateCalendarDays()
}
```

#### 3.2 ç»Ÿä¸€ ForEach Key ç”Ÿæˆé€»è¾‘

**ä¸»é¡µé¢çƒ­åŠ›æ ¼å­ - ä¼˜åŒ–å‰ï¼š**
```typescript
ForEach(weekCells, (cell: HeatmapCell, dayIndex: number) => {
  this.HeatmapCellBuilder(cell, weekIndex * 7 + dayIndex)
}, (cell: HeatmapCell, dayIdx: number) => 
  `${this.userConfig.heatmapTimeRange}_${this.userConfig.heatmapColorRange}_${this.userConfig.heatmapColorScheme}_${cell.dateStr || 'empty'}_${dayIdx}_${cell.count}_${cell.color}`
)
```

**ä¸»é¡µé¢çƒ­åŠ›æ ¼å­ - ä¼˜åŒ–åï¼š**
```typescript
ForEach(weekCells, (cell: HeatmapCell, dayIndex: number) => {
  this.HeatmapCellBuilder(cell, weekIndex * 7 + dayIndex)
}, (cell: HeatmapCell, dayIdx: number) => 
  `main_${this.historyUpdateTrigger.trigger}_${cell.dateStr || 'empty'}_${dayIdx}_${cell.count}_${cell.color}`
)
```

**å…¨å±æ¨¡å¼çƒ­åŠ›æ ¼å­ - ä¼˜åŒ–å‰ï¼š**
```typescript
ForEach(weekCells, (cell: HeatmapCell, dayIndex: number) => {
  this.HeatmapCellBuilder(cell, weekIndex * 7 + dayIndex)
}, (cell: HeatmapCell, dayIdx: number) => 
  `fs_${cell.dateStr || 'empty'}_${dayIdx}_${cell.count}`
)
```

**å…¨å±æ¨¡å¼çƒ­åŠ›æ ¼å­ - ä¼˜åŒ–åï¼š**
```typescript
ForEach(weekCells, (cell: HeatmapCell, dayIndex: number) => {
  this.HeatmapCellBuilder(cell, weekIndex * 7 + dayIndex)
}, (cell: HeatmapCell, dayIdx: number) => 
  `fs_${this.historyUpdateTrigger.trigger}_${cell.dateStr || 'empty'}_${dayIdx}_${cell.count}_${cell.color}`
)
```

**æœˆå†æ ¼å­ - ä¼˜åŒ–å‰ï¼š**
```typescript
ForEach(this.calendarDays, (cell: CalendarDayCell, index: number) => {
  GridItem() {
    this.CalendarDayCellBuilder(cell)
  }
}, (cell: CalendarDayCell, idx: number) => `cal_${cell.dateStr}_${idx}`)
```

**æœˆå†æ ¼å­ - ä¼˜åŒ–åï¼š**
```typescript
ForEach(this.calendarDays, (cell: CalendarDayCell, index: number) => {
  GridItem() {
    this.CalendarDayCellBuilder(cell)
  }
}, (cell: CalendarDayCell, idx: number) => 
  `cal_${this.historyUpdateTrigger.trigger}_${cell.dateStr}_${cell.count}_${cell.color}`
)
```

**æ”¹è¿›ç‚¹ï¼š**
- æ‰€æœ‰ ForEach key éƒ½åŒ…å« `historyUpdateTrigger.trigger`
- ç¡®ä¿è§¦å‘å™¨å˜åŒ–æ—¶å¼ºåˆ¶é‡æ–°æ¸²æŸ“
- ç»Ÿä¸€ä¸»é¡µé¢å’Œå…¨å±æ¨¡å¼çš„ key ç”Ÿæˆé€»è¾‘
- åŒ…å« `count` å’Œ `color` ç¡®ä¿æ•°æ®å˜åŒ–æ—¶æ›´æ–°

### 4. ä¿®å¤è¯­æ³•é”™è¯¯

**é—®é¢˜ä»£ç ï¼š**
```typescript
ForEach(this.getWeekColumns(), (weekCells: HeatmapCell[], weekIndex: number) => {
  Column() {
    ForEach(weekCells, (cell: HeatmapCell, dayIndex: number) => {
      this.HeatmapCellBuilder(cell, weekIndex * 7 + dayIndex)
    }, (cell: HeatmapCell, dayIdx: number) => `fs_${cell.dateStr || 'empty'}_${dayIdx}_${cell.count}`)
  }
}, (weekCells: HeatmapCell[], idx: number) => `fs_week_${idx}`)
  }  // å¤šä½™çš„é—­åˆæ‹¬å·
}, (weekCells: HeatmapCell[], idx: number) => `fs_week_${idx}`)  // é‡å¤çš„ ForEach ç»“å°¾
```

**ä¿®å¤åï¼š**
```typescript
ForEach(this.getWeekColumns(), (weekCells: HeatmapCell[], weekIndex: number) => {
  Column() {
    ForEach(weekCells, (cell: HeatmapCell, dayIndex: number) => {
      this.HeatmapCellBuilder(cell, weekIndex * 7 + dayIndex)
    }, (cell: HeatmapCell, dayIdx: number) => `fs_${this.historyUpdateTrigger.trigger}_${cell.dateStr || 'empty'}_${dayIdx}_${cell.count}_${cell.color}`)
  }
}, (weekCells: HeatmapCell[], idx: number) => `fs_week_${this.historyUpdateTrigger.trigger}_${idx}_${weekCells.length}`)
```

## ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ•°æ®è½¬æ¢æ¬¡æ•° | 3æ¬¡ (Mapâ†’Arrayâ†’Map) | 1æ¬¡ (Mapâ†’Map) | å‡å°‘66% |
| å†…å­˜å ç”¨ | éœ€è¦é¢å¤–æ•°ç»„å­˜å‚¨ | åªéœ€ä¸€ä¸ª Map | å‡å°‘çº¦50% |
| ä»£ç è¡Œæ•° | çº¦25è¡Œ | çº¦18è¡Œ | å‡å°‘28% |

### åŠŸèƒ½æ”¹è¿›

âœ… **ä¿®å¤å‰çš„é—®é¢˜ï¼š**
- ç‚¹å‡»æ–‡ç« åçƒ­åŠ›æ—¥å†é¢œè‰²ä¸æ›´æ–°
- ä¸»é¡µé¢å’Œå…¨å±æ¨¡å¼æ˜¾ç¤ºä¸ä¸€è‡´
- éœ€è¦åˆ‡æ¢é¡µé¢æ‰èƒ½çœ‹åˆ°æ›´æ–°

âœ… **ä¿®å¤åçš„æ•ˆæœï¼š**
- ç‚¹å‡»æ–‡ç« åç«‹å³æ›´æ–°é¢œè‰²
- ä¸»é¡µé¢å’Œå…¨å±æ¨¡å¼ä¿æŒåŒæ­¥
- å“åº”å¼æ›´æ–°æµç•…è‡ªç„¶

### ä»£ç è´¨é‡

- âœ… ç§»é™¤å†—ä½™çš„ `dailyStats` æ•°ç»„çŠ¶æ€å˜é‡
- âœ… ç®€åŒ–æ•°æ®åŠ è½½é€»è¾‘
- âœ… ç»Ÿä¸€ ForEach key ç”Ÿæˆè§„åˆ™
- âœ… ä¿®å¤ ArkTS è¯­æ³•é”™è¯¯
- âœ… æå‡ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§

## æŠ€æœ¯è¦ç‚¹

### 1. ArkTS å“åº”å¼æœºåˆ¶

åœ¨ ArkTS ä¸­ï¼Œ`@Local` è£…é¥°çš„ Map/Set ç­‰é›†åˆç±»å‹ï¼Œå…¶å†…éƒ¨å˜åŒ–ï¼ˆå¦‚ `set()`ã€`delete()`ï¼‰ä¸ä¼šè§¦å‘ UI æ›´æ–°ã€‚éœ€è¦é€šè¿‡é‡æ–°èµ‹å€¼æ¥è§¦å‘ï¼š

```typescript
// âŒ ä¸ä¼šè§¦å‘æ›´æ–°
this.statsMap.set(key, value)

// âœ… ä¼šè§¦å‘æ›´æ–°
this.statsMap = new Map(this.statsMap)
// æˆ–
const newMap = await loadData()
this.statsMap = newMap
```

### 2. ForEach Key çš„é‡è¦æ€§

ForEach çš„ key å‡½æ•°å†³å®šäº†ç»„ä»¶çš„å¤ç”¨å’Œæ›´æ–°ç­–ç•¥ï¼š

```typescript
// âŒ ä¸å¥½çš„ keyï¼šåªåŒ…å«é™æ€ä¿¡æ¯
(item, idx) => `${item.id}_${idx}`

// âœ… å¥½çš„ keyï¼šåŒ…å«èƒ½åæ˜ å˜åŒ–çš„åŠ¨æ€ä¿¡æ¯
(item, idx) => `${this.updateTrigger}_${item.id}_${item.value}_${item.color}`
```

### 3. æ•°æ®ç»“æ„é€‰æ‹©

æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ï¼š

- **éœ€è¦é¡ºåºéå†**ï¼šä½¿ç”¨ Array
- **éœ€è¦å¿«é€ŸæŸ¥æ‰¾**ï¼šä½¿ç”¨ Map
- **UI æ¸²æŸ“éœ€è¦**ï¼šä¼˜å…ˆè€ƒè™‘ UI å±‚çš„ä½¿ç”¨æ–¹å¼

æœ¬æ¬¡ä¼˜åŒ–ä¸­ï¼ŒUI å±‚ä¸»è¦é€šè¿‡æ—¥æœŸå­—ç¬¦ä¸²æŸ¥æ‰¾é˜…è¯»æ•°é‡ï¼Œå› æ­¤ Map æ˜¯æœ€ä¼˜é€‰æ‹©ã€‚

## å½±å“èŒƒå›´

### ä¿®æ”¹æ–‡ä»¶

1. `features/feature/src/main/ets/managers/HistoryManager.ets`
   - æ–°å¢ `getDailyCountMapInRange()` æ–¹æ³•
   - ä¿ç•™åŸæœ‰ `getDailyStatsInRange()` æ–¹æ³•ä»¥ä¿æŒå…¼å®¹æ€§

2. `product/default/src/main/ets/pages/tab_contents/CalenderTabContent.ets`
   - ç§»é™¤ `dailyStats` çŠ¶æ€å˜é‡
   - ä¼˜åŒ– `loadDailyStats()` æ–¹æ³•
   - å®Œå–„ `onHistoryUpdate()` ç›‘å¬å™¨
   - ç»Ÿä¸€æ‰€æœ‰ ForEach key ç”Ÿæˆé€»è¾‘
   - ä¿®å¤è¯­æ³•é”™è¯¯

### å…¼å®¹æ€§

- âœ… ä¿ç•™åŸæœ‰ `getDailyStatsInRange()` æ¥å£ï¼Œä¸å½±å“å…¶ä»–å¯èƒ½çš„è°ƒç”¨
- âœ… æ–°å¢æ¥å£ä¸ºå¯é€‰ä½¿ç”¨ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½
- âœ… UI å±‚æ”¹åŠ¨ä»…é™äºå†…éƒ¨å®ç°ï¼Œä¸å½±å“å¤–éƒ¨æ¥å£

## åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ç›‘æ§**
   - æ·»åŠ æ•°æ®åŠ è½½è€—æ—¶ç»Ÿè®¡
   - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
   - æ”¶é›†ç”¨æˆ·ä½“éªŒåé¦ˆ

2. **åŠŸèƒ½å¢å¼º**
   - è€ƒè™‘æ·»åŠ æ•°æ®ç¼“å­˜æœºåˆ¶
   - ä¼˜åŒ–å¤§æ•°æ®é‡åœºæ™¯çš„æ¸²æŸ“æ€§èƒ½
   - æ”¯æŒæ›´çµæ´»çš„æ—¶é—´èŒƒå›´é€‰æ‹©

3. **ä»£ç é‡æ„**
   - è€ƒè™‘å°†çƒ­åŠ›æ ¼å­å’Œæœˆå†æŠ½å–ä¸ºç‹¬ç«‹ç»„ä»¶
   - ç»Ÿä¸€é¢œè‰²è®¡ç®—é€»è¾‘
   - æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–

## æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–é€šè¿‡å¼•å…¥æ–°çš„æ•°æ®æ¥å£ã€ä¼˜åŒ–æ•°æ®æµè½¬è·¯å¾„ã€ä¿®å¤å“åº”å¼æ›´æ–°æœºåˆ¶ï¼ŒæˆåŠŸè§£å†³äº†çƒ­åŠ›æ—¥å†çš„æ€§èƒ½å’ŒåŠŸèƒ½é—®é¢˜ã€‚ä¼˜åŒ–åçš„ä»£ç æ›´åŠ ç®€æ´é«˜æ•ˆï¼Œç”¨æˆ·ä½“éªŒå¾—åˆ°æ˜¾è‘—æå‡ã€‚

**æ ¸å¿ƒæ”¹è¿›ï¼š**
- ğŸš€ æ€§èƒ½æå‡ï¼šå‡å°‘66%çš„æ•°æ®è½¬æ¢æ¬¡æ•°
- ğŸ¯ åŠŸèƒ½ä¿®å¤ï¼šå®ç°å®æ—¶å“åº”å¼æ›´æ–°
- ğŸ“ ä»£ç è´¨é‡ï¼šå‡å°‘28%çš„ä»£ç è¡Œæ•°ï¼Œæå‡å¯ç»´æŠ¤æ€§

---

**ä¼˜åŒ–æ—¥æœŸï¼š** 2025-01-17  
**ä¼˜åŒ–äººå‘˜ï¼š** XBXyftx  
**ç‰ˆæœ¬ï¼š** v1.0
