# 收藏功能实现说明

## 📋 功能概述

实现了用户收藏新闻的功能，包括：
- 在文章详情页添加/取消收藏
- 收藏按钮根据收藏状态显示不同图标
- 在"我的"页面查看收藏列表
- 支持删除单条收藏
- 支持清空所有收藏
- 点击收藏项可跳转到文章详情页
- 实时响应式更新（跨组件数据同步）

## 🎯 技术实现

### 1. 数据存储

**位置**: `commons/common/src/main/ets/modules/enums.ets`

新增数据库键：
```typescript
export enum KV_DB_KEYS {
  // ... 其他键
  /** 收藏列表 - 存储用户收藏的新闻文章 */
  FAVORITE_LIST = 'FavoriteList'
}
```

新增日志标签：
```typescript
export enum LOG_TAG {
  // ... 其他标签
  /** 收藏管理器 - 管理用户收藏 */
  FAVORITE_MANAGER = 'FavoriteManager: '
}
```

新增 AppStorage 键：
```typescript
export enum APP_STORAGE_KEYS {
  // ... 其他键
  /** 收藏更新触发器 */
  FAVORITE_UPDATE_TRIGGER = 'favoriteUpdateTrigger'
}
```

新增导航目标：
```typescript
export enum NAV_DESTS {
  // ... 其他目标
  /** 收藏列表页 - 显示用户收藏的新闻 */
  FAVORITES = 'Favorites'
}
```

### 2. 响应式更新机制 ⭐

**位置**: `commons/common/src/main/ets/modules/view/FavoriteUpdateTrigger.ets`

创建了全局触发器类，用于实现跨组件的数据同步：

```typescript
@ObservedV2
export class FavoriteUpdateTrigger {
  @Trace trigger: number = 0
}
```

**工作原理**：
1. `FavoriteManager` 在添加/删除/清空收藏后，调用 `notifyFavoriteUpdate()` 递增触发器值
2. `SelfTabContent` 和 `FavoritesPage` 通过 `@Monitor` 监听触发器变化
3. 触发器变化时自动调用 `onFavoriteUpdate()` 重新加载数据
4. 实现实时更新，无需手动刷新

**优势**：
- ✅ 自动同步：无需手动刷新
- ✅ 解耦设计：组件间无直接依赖
- ✅ 性能优化：仅在数据变化时更新
- ✅ 可扩展：其他组件也可监听同一触发器

### 3. 收藏管理器

**位置**: `features/feature/src/main/ets/managers/FavoriteManager.ets`

#### 核心功能

1. **添加收藏** (`addFavorite`)
   - 自动去重（相同文章不会重复收藏）
   - 最新收藏排在前面
   - 限制最多保存 200 条记录
   - ⭐ 添加成功后触发更新通知

2. **删除收藏** (`removeFavorite`)
   - 根据文章 ID 删除指定收藏
   - ⭐ 删除成功后触发更新通知

3. **检查收藏状态** (`isFavorite`)
   - 检查指定文章是否已收藏
   - 用于更新文章页的收藏按钮状态

4. **获取收藏列表** (`getFavoriteList`)
   - 返回按时间倒序排列的收藏数组

5. **清空所有收藏** (`clearAllFavorites`)
   - 清空所有收藏
   - ⭐ 清空成功后触发更新通知

6. **触发更新通知** (`notifyFavoriteUpdate`) - 私有方法 ⭐
   - 递增全局触发器的值
   - 通知所有监听组件刷新数据
   - 在添加/删除/清空操作后自动调用

#### 数据结构

```typescript
interface FavoriteItem {
  article: NewsArticle      // 新闻文章数据
  timestamp: number         // 收藏时间戳
  dateStr: string          // 格式化的日期字符串
}
```

### 4. 文章详情页收藏按钮

**位置**: `product/default/src/main/ets/pages/nav_pages/ArticlePage.ets`

#### 功能特性

1. **动态图标显示**
   - 未收藏：显示空心爱心图标 (`favorite_outline.svg`)
   - 已收藏：显示实心红色爱心图标 (`favorite_filled.svg`)

2. **状态检查**
   - 页面加载时自动检查收藏状态
   - 使用 `checkFavoriteStatus()` 方法

3. **切换收藏**
   - 点击按钮切换收藏状态
   - 显示 Toast 提示操作结果
   - 自动触发全局更新

#### 核心代码

```typescript
@Local isFavorite: boolean = false

async checkFavoriteStatus(): Promise<void> {
  this.isFavorite = await favoriteManager.isFavorite(this.article.id)
}

async toggleFavorite(): Promise<void> {
  if (this.isFavorite) {
    const success = await favoriteManager.removeFavorite(this.article.id)
    if (success) {
      this.isFavorite = false
      promptAction.openToast({ message: '已取消收藏', duration: 1500 })
    }
  } else {
    const success = await favoriteManager.addFavorite(this.article)
    if (success) {
      this.isFavorite = true
      promptAction.openToast({ message: '已添加到收藏', duration: 1500 })
    }
  }
}
```

### 5. 收藏列表页面

**位置**: `product/default/src/main/ets/pages/nav_pages/FavoritesPage.ets`

#### 响应式数据更新 ⭐

使用 `@Monitor` 装饰器监听全局触发器：

```typescript
@Local favoriteUpdateTrigger: FavoriteUpdateTrigger = 
  AppStorageV2.connect(FavoriteUpdateTrigger, APP_STORAGE_KEYS.FAVORITE_UPDATE_TRIGGER, () => new FavoriteUpdateTrigger())!

@Monitor('favoriteUpdateTrigger.trigger')
async onFavoriteUpdate(): Promise<void> {
  logger.info(`检测到收藏更新，重新加载数据`)
  await this.loadFavorites()
}
```

**工作流程**：
1. 用户在文章页添加/取消收藏
2. `FavoriteManager` 触发更新通知（trigger++）
3. `FavoritesPage` 的 `@Monitor` 检测到变化
4. 自动调用 `onFavoriteUpdate()` 重新加载数据
5. 用户在收藏页看到最新数据

#### 界面布局

1. **标题栏**
   - 显示"我的收藏"标题
   - 返回按钮
   - 右侧显示"清空"按钮（仅在有收藏时显示）

2. **收藏列表**
   - 每条记录显示：
     - 文章标题（最多 2 行）
     - 来源和收藏时间
     - 删除按钮
   - 点击记录跳转到文章详情页
   - 点击删除按钮取消收藏
   - 卡片带阴影效果

3. **空状态**
   - 无收藏时显示空状态图标和提示文字

4. **清空确认对话框**
   - 点击"清空"按钮时弹出确认对话框
   - 包含"取消"和"确定"按钮

#### 响应式设计

- 支持手机和平板两种设备类型
- 根据设备类型自动调整字体大小、间距和布局

#### 时间显示格式

- 1 分钟内：显示"刚刚"
- 1 小时内：显示"X分钟前"
- 24 小时内：显示"X小时前"
- 7 天内：显示"X天前"
- 7 天以上：显示"X月X日"

### 6. "我的"页面入口

**位置**: `product/default/src/main/ets/pages/tab_contents/SelfTabContent.ets`

#### 功能特性

1. **收藏卡片**
   - 显示收藏图标、标题和副标题
   - 实时显示收藏数量徽章
   - 点击跳转到收藏列表页

2. **响应式更新**
   - 监听收藏更新触发器
   - 自动更新收藏数量徽章

#### 核心代码

```typescript
@Local favoriteUpdateTrigger: FavoriteUpdateTrigger = 
  AppStorageV2.connect(FavoriteUpdateTrigger, APP_STORAGE_KEYS.FAVORITE_UPDATE_TRIGGER, () => new FavoriteUpdateTrigger())!
@Local favoriteCount: number = 0

@Monitor('favoriteUpdateTrigger.trigger')
async onFavoriteUpdate(): Promise<void> {
  await this.updateFavoriteCount()
}

async updateFavoriteCount(): Promise<void> {
  const favoriteList = await favoriteManager.getFavoriteList()
  this.favoriteCount = favoriteList.length
}

// 收藏卡片
this.MenuCardBuilder(
  $rawfile('favorite_icon.svg'),
  '我的收藏',
  '查看你收藏的新闻',
  this.favoriteCount,
  () => {
    this.navPathStuck.replacePath({ name: NAV_DESTS.FAVORITES })
  }
)
```

## 📦 文件清单

### 新增文件

1. `features/feature/src/main/ets/managers/FavoriteManager.ets` - 收藏管理器
2. `commons/common/src/main/ets/modules/view/FavoriteUpdateTrigger.ets` - ⭐ 更新触发器
3. `product/default/src/main/ets/pages/nav_pages/FavoritesPage.ets` - 收藏列表页面
4. `product/default/src/main/resources/rawfile/favorite_icon.svg` - 收藏图标
5. `product/default/src/main/resources/rawfile/favorite_outline.svg` - 空心爱心图标
6. `product/default/src/main/resources/rawfile/favorite_filled.svg` - 实心爱心图标
7. `product/default/src/main/resources/rawfile/empty_favorite.svg` - 空状态图标

### 修改文件

1. `commons/common/src/main/ets/modules/enums.ets` - 添加数据库键、日志标签、AppStorage 键和导航目标
2. `commons/common/src/main/ets/modules/view/index.ets` - 导出 FavoriteUpdateTrigger
3. `features/feature/src/main/ets/managers/index.ets` - 导出 FavoriteManager
4. `product/default/src/main/ets/pages/tab_contents/SelfTabContent.ets` - 添加收藏入口卡片
5. `product/default/src/main/ets/pages/nav_pages/ArticlePage.ets` - 添加收藏按钮
6. `product/default/src/main/ets/pages/Index.ets` - 添加路由映射

## 🎨 技术特点

### 1. 响应式更新 ⭐

**问题**：用户在文章页添加收藏后，"我的"页面和收藏列表页的数据不会自动更新

**解决方案**：使用 AppStorageV2 + @Monitor 实现跨组件响应式更新

**实现细节**：
```typescript
// 1. 创建全局触发器类
@ObservedV2
export class FavoriteUpdateTrigger {
  @Trace trigger: number = 0
}

// 2. FavoriteManager 在数据变化时触发更新
private notifyFavoriteUpdate(): void {
  const trigger = AppStorageV2.connect(...)
  trigger.trigger++  // 递增触发器
}

// 3. 组件监听触发器变化
@Monitor('favoriteUpdateTrigger.trigger')
async onFavoriteUpdate(): Promise<void> {
  await this.loadFavorites()  // 自动重新加载数据
}
```

**优势**：
- ✅ 实时更新：无需手动刷新
- ✅ 自动同步：切换页面即可看到最新数据
- ✅ 解耦设计：组件间无直接依赖
- ✅ 性能优化：仅在数据变化时更新

### 2. 自动去重

- 使用 `findIndex` 查找是否已存在相同文章
- 如果已存在，不会重复添加
- 确保每篇文章只有一条收藏记录

### 3. 性能优化

- 限制最多保存 200 条记录，避免数据过大
- 使用 KV 数据库存储，读写速度快
- 异步操作，不阻塞 UI

### 4. 用户体验

- 收藏按钮状态实时更新
- 时间显示人性化（刚刚、X分钟前等）
- 支持删除和清空操作
- 空状态提示友好
- Toast 提示操作结果
- 卡片阴影效果增强视觉层次

### 5. 错误处理

- 所有数据库操作都有 try-catch 保护
- 失败时显示 Toast 提示
- 详细的日志记录，便于调试

## 🚀 使用方式

### 用户操作流程

1. **添加收藏**
   - 在新闻列表中点击任意新闻
   - 进入文章详情页
   - 点击右上角的收藏按钮（空心爱心）
   - 按钮变为实心红色爱心，显示"已添加到收藏"

2. **取消收藏**
   - 在文章详情页点击收藏按钮（实心爱心）
   - 按钮变为空心爱心，显示"已取消收藏"
   - 或在收藏列表页点击删除按钮

3. **查看收藏列表**
   - 切换到"我的"标签页
   - 点击"我的收藏"卡片（显示收藏数量徽章）
   - 查看收藏列表

4. **删除单条收藏**
   - 在收藏列表页点击收藏项右侧的删除图标
   - 该条收藏立即被删除

5. **清空所有收藏**
   - 在收藏列表页点击右上角的"清空"按钮
   - 在确认对话框中点击"确定"
   - 所有收藏被清空

6. **重新阅读收藏文章**
   - 在收藏列表页点击收藏项
   - 跳转到文章详情页

## 🔄 数据流转

```
用户操作
   ↓
ArticlePage.toggleFavorite()
   ↓
FavoriteManager.addFavorite() / removeFavorite()
   ↓
KV 数据库写入
   ↓
FavoriteManager.notifyFavoriteUpdate()
   ↓
FavoriteUpdateTrigger.trigger++
   ↓
SelfTabContent.onFavoriteUpdate() ← @Monitor 监听
FavoritesPage.onFavoriteUpdate() ← @Monitor 监听
   ↓
重新加载数据
   ↓
UI 自动更新
```

## 🎯 与历史记录功能的对比

| 特性 | 历史记录 | 收藏功能 |
|------|---------|---------|
| **触发方式** | 自动记录（打开文章） | 手动添加（点击按钮） |
| **数据上限** | 100 条 | 200 条 |
| **去重策略** | 更新时间戳 | 不允许重复 |
| **状态显示** | 无 | 收藏按钮状态 |
| **用户控制** | 只能删除 | 可添加/删除 |
| **使用场景** | 浏览记录 | 重要内容保存 |

## 📊 未来扩展方向

1. **收藏分类**
   - 支持创建收藏夹
   - 将收藏分类管理

2. **搜索收藏**
   - 根据标题或来源搜索

3. **收藏统计**
   - 显示总收藏数量
   - 显示最常收藏的分类

4. **同步到云端**
   - 多设备同步收藏

5. **导出收藏**
   - 导出为 JSON 或 CSV 文件

6. **收藏笔记**
   - 为收藏添加个人笔记

## ✅ 总结

收藏功能已完整实现，包括：
- ✅ 文章详情页添加/取消收藏
- ✅ 收藏按钮状态实时更新
- ✅ 收藏列表展示
- ✅ 删除单条收藏
- ✅ 清空所有收藏
- ✅ 跳转到文章详情
- ✅ 响应式设计
- ✅ 错误处理
- ✅ 性能优化
- ✅ ⭐ **实时响应式更新**（无需手动刷新）
- ✅ 收藏数量徽章实时显示

该功能与项目现有架构完美融合，代码风格统一，注释详细，易于维护和扩展。与历史记录功能形成完整的用户内容管理体系。
