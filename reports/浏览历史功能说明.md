# 浏览历史功能实现说明

## 功能概述

实现了用户浏览新闻的历史记录功能，包括：
- 自动记录用户浏览的新闻
- 按时间倒序显示历史记录
- 支持删除单条历史记录
- 支持清空所有历史记录
- 点击历史记录可跳转到文章详情页

## 技术实现

### 1. 数据存储

**位置**: `commons/common/src/main/ets/modules/enums.ets`

新增数据库键：
```typescript
export enum KV_DB_KEYS {
  // ... 其他键
  /** 浏览历史记录 - 存储用户浏览过的新闻文章 */
  READING_HISTORY = 'ReadingHistory'
}
```

新增日志标签：
```typescript
export enum LOG_TAG {
  // ... 其他标签
  /** 历史记录管理器 - 管理用户浏览历史 */
  HISTORY_MANAGER = 'HistoryManager: '
}
```

新增 AppStorage 键：
```typescript
export enum APP_STORAGE_KEYS {
  // ... 其他键
  /** 历史记录更新触发器 */
  HISTORY_UPDATE_TRIGGER = 'historyUpdateTrigger'
}
```

### 1.5 响应式更新机制 ⭐

**位置**: `commons/common/src/main/ets/modules/view/HistoryUpdateTrigger.ets`

创建了全局触发器类，用于实现跨组件的数据同步：

```typescript
@ObservedV2
export class HistoryUpdateTrigger {
  @Trace trigger: number = 0
}
```

**工作原理**：
1. `HistoryManager` 在添加/删除/清空历史记录后，调用 `notifyHistoryUpdate()` 递增触发器值
2. `SelfTabContent` 通过 `@Monitor` 监听触发器变化
3. 触发器变化时自动调用 `onHistoryUpdate()` 重新加载数据
4. 实现实时更新，无需手动刷新

**优势**：
- ✅ 自动同步：无需手动刷新
- ✅ 解耦设计：组件间无直接依赖
- ✅ 性能优化：仅在数据变化时更新
- ✅ 可扩展：其他组件也可监听同一触发器

### 2. 历史记录管理器

**位置**: `features/feature/src/main/ets/managers/HistoryManager.ets`

#### 核心功能

1. **添加历史记录** (`addHistory`)
   - 自动去重（相同文章只保留最新的浏览记录）
   - 最新记录排在前面
   - 限制最多保存 100 条记录
   - ⭐ 添加成功后触发更新通知

2. **获取历史记录** (`getHistoryList`)
   - 返回按时间倒序排列的历史记录数组

3. **删除单条记录** (`deleteHistory`)
   - 根据文章 ID 删除指定记录
   - ⭐ 删除成功后触发更新通知

4. **清空所有记录** (`clearAllHistory`)
   - 清空所有浏览历史
   - ⭐ 清空成功后触发更新通知

5. **按日期分组** (`getGroupedHistory`)
   - 将历史记录按日期分组（可用于未来的分组显示）

6. **触发更新通知** (`notifyHistoryUpdate`) - 私有方法 ⭐
   - 递增全局触发器的值
   - 通知所有监听组件刷新数据
   - 在添加/删除/清空操作后自动调用

#### 数据结构

```typescript
interface HistoryItem {
  article: NewsArticle      // 新闻文章数据
  timestamp: number         // 浏览时间戳
  dateStr: string          // 格式化的日期字符串
}
```

### 3. 自动记录浏览历史

**位置**: `features/feature/src/main/ets/components/NewsComponents/NewsArticle.ets`

在文章详情页的 `aboutToAppear` 生命周期中自动添加历史记录：

```typescript
async aboutToAppear(): Promise<void> {
  // 添加浏览历史记录
  try {
    const success = await historyManager.addHistory(this.article)
    if (success) {
      logger.info(`添加浏览历史成功: ${this.article.title}`)
    }
  } catch (error) {
    logger.error(`添加浏览历史失败: ${JSON.stringify(error)}`)
  }
}
```

### 4. UI 界面实现

**位置**: `product/default/src/main/ets/pages/tab_contents/SelfTabContent.ets`

#### 响应式数据更新 ⭐

使用 `@Monitor` 装饰器监听全局触发器：

```typescript
@Local historyUpdateTrigger: HistoryUpdateTrigger = 
  AppStorageV2.connect(HistoryUpdateTrigger, APP_STORAGE_KEYS.HISTORY_UPDATE_TRIGGER, () => new HistoryUpdateTrigger())!

@Monitor('historyUpdateTrigger.trigger')
async onHistoryUpdate(): Promise<void> {
  logger.info(`检测到历史记录更新，重新加载数据`)
  await this.loadHistory()
}
```

**工作流程**：
1. 用户在其他 Tab 浏览新闻
2. `NewsArticle` 组件添加历史记录
3. `HistoryManager` 触发更新通知（trigger++）
4. `SelfTabContent` 的 `@Monitor` 检测到变化
5. 自动调用 `onHistoryUpdate()` 重新加载数据
6. 用户切换回"我的"Tab 时看到最新数据

#### 界面布局

1. **标题栏**
   - 显示"浏览历史"标题
   - 右侧显示"清空"按钮（仅在有历史记录时显示）

2. **历史记录列表**
   - 每条记录显示：
     - 文章标题（最多 2 行）
     - 来源和浏览时间
     - 删除按钮
   - 点击记录跳转到文章详情页
   - 点击删除按钮删除该条记录

3. **空状态**
   - 无历史记录时显示空状态图标和提示文字

4. **清空确认对话框**
   - 点击"清空"按钮时弹出确认对话框
   - 包含"取消"和"确定"按钮

#### 响应式设计

- 支持手机和平板两种设备类型
- 根据设备类型自动调整字体大小、间距和布局

#### 时间显示格式

- 1 分钟内：显示"刚刚"
- 1 小时内：显示"X分钟前"
- 24 小时内：显示"X小时前"
- 7 天内：显示"X天前"
- 7 天以上：显示"X月X日"

## 使用方式

### 用户操作流程

1. **浏览新闻**
   - 在新闻列表中点击任意新闻
   - 进入文章详情页时自动记录浏览历史

2. **查看历史记录**
   - 切换到"我的"标签页
   - 查看浏览历史列表

3. **删除单条记录**
   - 点击历史记录右侧的删除图标
   - 该条记录立即被删除

4. **清空所有记录**
   - 点击右上角的"清空"按钮
   - 在确认对话框中点击"确定"
   - 所有历史记录被清空

5. **重新浏览历史文章**
   - 点击历史记录项
   - 跳转到文章详情页

## 文件清单

### 新增文件

1. `features/feature/src/main/ets/managers/HistoryManager.ets` - 历史记录管理器
2. `commons/common/src/main/ets/modules/view/HistoryUpdateTrigger.ets` - ⭐ 更新触发器
3. `product/default/src/main/resources/rawfile/delete.svg` - 删除图标
4. `product/default/src/main/resources/rawfile/empty_history.svg` - 空状态图标

### 修改文件

1. `commons/common/src/main/ets/modules/enums.ets` - 添加数据库键、日志标签和 AppStorage 键 ⭐
2. `commons/common/src/main/ets/modules/view/index.ets` - 导出 HistoryUpdateTrigger ⭐
3. `features/feature/src/main/ets/managers/index.ets` - 导出 HistoryManager
4. `features/feature/src/main/ets/components/NewsComponents/NewsArticle.ets` - 添加历史记录
5. `product/default/src/main/ets/pages/tab_contents/SelfTabContent.ets` - 实现 UI 界面和响应式更新 ⭐
6. `product/default/src/main/resources/base/element/color.json` - 添加颜色资源

## 技术特点

### 0. 响应式更新 ⭐ NEW!

**问题**：用户浏览新闻后切换到历史记录页面，数据不会自动更新

**解决方案**：使用 AppStorageV2 + @Monitor 实现跨组件响应式更新

**实现细节**：
```typescript
// 1. 创建全局触发器类
@ObservedV2
export class HistoryUpdateTrigger {
  @Trace trigger: number = 0
}

// 2. HistoryManager 在数据变化时触发更新
private notifyHistoryUpdate(): void {
  const trigger = AppStorageV2.connect(...)
  trigger.trigger++  // 递增触发器
}

// 3. SelfTabContent 监听触发器变化
@Monitor('historyUpdateTrigger.trigger')
async onHistoryUpdate(): Promise<void> {
  await this.loadHistory()  // 自动重新加载数据
}
```

**优势**：
- ✅ 实时更新：无需手动刷新
- ✅ 自动同步：切换 Tab 即可看到最新数据
- ✅ 解耦设计：组件间无直接依赖
- ✅ 性能优化：仅在数据变化时更新

### 1. 自动去重
- 使用 `findIndex` 查找是否已存在相同文章
- 如果存在，先删除旧记录，再添加新记录
- 确保每篇文章只有一条最新的浏览记录

### 2. 性能优化
- 限制最多保存 100 条记录，避免数据过大
- 使用 KV 数据库存储，读写速度快
- 异步操作，不阻塞 UI

### 3. 用户体验
- 自动记录，无需用户手动操作
- 时间显示人性化（刚刚、X分钟前等）
- 支持删除和清空操作
- 空状态提示友好

### 4. 错误处理
- 所有数据库操作都有 try-catch 保护
- 失败时显示 Toast 提示
- 详细的日志记录，便于调试

## 未来扩展方向

1. **按日期分组显示**
   - 今天、昨天、更早
   - 使用 `getGroupedHistory()` 方法

2. **搜索历史记录**
   - 根据标题或来源搜索

3. **历史记录统计**
   - 显示总浏览数量
   - 显示最常浏览的分类

4. **同步到云端**
   - 多设备同步浏览历史

5. **导出历史记录**
   - 导出为 JSON 或 CSV 文件

## 测试建议

### 功能测试

1. **添加历史记录**
   - 浏览多篇新闻，检查是否正确记录
   - 重复浏览同一篇新闻，检查是否去重

2. **删除历史记录**
   - 删除单条记录，检查是否成功
   - 清空所有记录，检查是否成功

3. **时间显示**
   - 检查不同时间段的显示格式是否正确

4. **跳转功能**
   - 点击历史记录，检查是否正确跳转到文章详情页

### 边界测试

1. **空状态**
   - 无历史记录时的显示

2. **大量数据**
   - 添加超过 100 条记录，检查是否正确限制

3. **网络异常**
   - 数据库操作失败时的错误处理

## 总结

浏览历史功能已完整实现，包括：
- ✅ 自动记录浏览历史
- ✅ 历史记录列表展示
- ✅ 删除单条记录
- ✅ 清空所有记录
- ✅ 跳转到文章详情
- ✅ 响应式设计
- ✅ 错误处理
- ✅ 性能优化
- ✅ ⭐ **实时响应式更新**（无需手动刷新）

该功能与项目现有架构完美融合，代码风格统一，注释详细，易于维护和扩展。

## 更新日志

### v1.1 - 2024-11-22
- ⭐ **新增响应式更新机制**
  - 创建 `HistoryUpdateTrigger` 全局触发器
  - `HistoryManager` 在数据变化时自动触发更新通知
  - `SelfTabContent` 使用 `@Monitor` 监听触发器变化
  - 实现跨组件实时数据同步
  - 解决了切换 Tab 后数据不更新的问题

### v1.0 - 2024-11-22
- 初始版本发布
- 实现基础的浏览历史功能
