# 阅读热力日历功能说明

## 功能概述

阅读热力日历是一个仿照 GitHub 贡献热力图设计的功能，用于可视化展示用户每天的新闻阅读情况。通过颜色深浅直观地反映用户的阅读活跃度，帮助用户了解自己的阅读习惯。

## 功能特性

### 1. 热力图展示
- 采用 GitHub 风格的热力图布局，按周排列显示
- 每个小方块代表一天，颜色越亮代表当天阅读的新闻越多
- 支持横向滚动查看更多日期

### 2. 统计信息
- 显示选定时间范围内的总阅读篇数
- 实时更新，阅读新文章后自动刷新

### 3. 交互功能
- 点击有阅读记录的日期方块，可跳转查看当天阅读的文章列表
- 支持开关此交互功能

### 4. 可配置项
| 配置项 | 说明 | 可选值 | 默认值 |
|--------|------|--------|--------|
| 显示范围 | 热力图显示的时间范围 | 7天/30天/90天/180天/365天 | 7天 |
| 颜色范围 | 颜色梯度的最大值 | 0-10篇/0-50篇/0-100篇/0-500篇 | 0-10篇 |
| 颜色系 | 热力图的颜色主题 | 蓝色系/绿色系/红色系/灰色系 | 绿色系 |
| 点击跳转 | 点击方块是否跳转历史 | 开/关 | 开 |

### 5. 数据去重
- 单日内重复阅读同一篇文章只计算一次
- 不同日期阅读同一篇文章分别计数

## 技术实现

### 文件结构

```
commons/common/src/main/ets/
├── modules/
│   ├── models/
│   │   └── DailyReadingStats.ets    # 每日阅读统计数据模型
│   ├── config/
│   │   └── UserConfigViewModel.ets  # 用户配置（含热力日历配置）
│   └── enums.ets                    # 枚举定义（含热力日历相关枚举）

features/feature/src/main/ets/
├── managers/
│   ├── HistoryManager.ets           # 历史记录管理器（含每日统计功能）
│   └── UserConfigManager.ets        # 用户配置管理器（含配置持久化）

product/default/src/main/ets/
├── pages/
│   ├── tab_contents/
│   │   └── CalenderTabContent.ets   # 热力日历主页面
│   └── nav_pages/
│       ├── HeatmapSettingsPage.ets  # 热力日历设置页面
│       ├── DateHistoryPage.ets      # 按日期查看历史记录页面
│       └── SettingsPage.ets         # 设置页面（含清理数据功能）
└── resources/rawfile/
    └── calendar_icon.svg            # 日历图标
```

### 数据模型

#### DailyReadingStats（每日阅读统计）
```typescript
interface DailyReadingStats {
  dateStr: string      // 日期字符串，格式：YYYY-MM-DD
  count: number        // 当天阅读的新闻数量（已去重）
  articleIds: string[] // 当天阅读的新闻ID集合（用于去重）
}
```

#### 热力日历配置枚举
```typescript
// 颜色系
enum HeatmapColorScheme {
  BLUE = 'blue',
  GREEN = 'green',
  RED = 'red',
  GRAY = 'gray'
}

// 时间范围
enum HeatmapTimeRange {
  DAYS_7 = 7,
  DAYS_30 = 30,
  DAYS_90 = 90,
  DAYS_180 = 180,
  DAYS_365 = 365
}

// 颜色范围
enum HeatmapColorRange {
  RANGE_10 = 10,
  RANGE_50 = 50,
  RANGE_100 = 100,
  RANGE_500 = 500
}
```

### 核心逻辑

#### 1. 每日统计更新流程
```
用户阅读文章 
    → HistoryManager.addHistory() 
    → 保存历史记录 
    → updateDailyStats() 
    → 检查当天是否已阅读该文章（去重）
    → 更新每日统计数据
    → 触发UI更新通知
```

#### 2. 颜色计算算法
```typescript
getColorForCount(count: number): string {
  const ratio = Math.min(count / maxRange, 1)
  
  if (count === 0) return colors[0]      // 无阅读
  if (ratio <= 0.25) return colors[1]    // 少量阅读
  if (ratio <= 0.5) return colors[2]     // 中等阅读
  if (ratio <= 0.75) return colors[3]    // 较多阅读
  return colors[4]                        // 大量阅读
}
```

#### 3. 热力图布局
- 按周分组，每列7天（周日到周六）
- 第一周前面填充空白格子对齐星期
- 支持横向滚动查看历史数据

### 数据存储

| 数据类型 | 存储位置 | 键名 |
|----------|----------|------|
| 每日统计 | KV数据库 | DAILY_READING_STATS |
| 配置项 | PreferenceDB | HEATMAP_TIME_RANGE / HEATMAP_COLOR_RANGE / HEATMAP_CLICK_TO_HISTORY / HEATMAP_COLOR_SCHEME |

### 响应式更新

热力日历页面监听以下状态变化：
- `historyUpdateTrigger.trigger` - 历史记录更新时刷新数据
- `userConfig.heatmapTimeRange` - 时间范围变化时重新加载
- `userConfig.heatmapColorRange` - 颜色范围变化时重新生成格子
- `userConfig.heatmapColorScheme` - 颜色系变化时重新生成格子

## 颜色方案

### 绿色系（默认）
| 等级 | 颜色 | 说明 |
|------|------|------|
| 0 | #2d333b | 无阅读 |
| 1 | #0e4429 | 少量阅读 |
| 2 | #006d32 | 中等阅读 |
| 3 | #26a641 | 较多阅读 |
| 4 | #39d353 | 大量阅读 |

### 蓝色系
| 等级 | 颜色 | 说明 |
|------|------|------|
| 0 | #2d333b | 无阅读 |
| 1 | #1e3a5f | 少量阅读 |
| 2 | #2563eb | 中等阅读 |
| 3 | #60a5fa | 较多阅读 |
| 4 | #93c5fd | 大量阅读 |

### 红色系
| 等级 | 颜色 | 说明 |
|------|------|------|
| 0 | #2d333b | 无阅读 |
| 1 | #5c2121 | 少量阅读 |
| 2 | #8b3d3d | 中等阅读 |
| 3 | #d35f5f | 较多阅读 |
| 4 | #ff8080 | 大量阅读 |

### 灰色系
| 等级 | 颜色 | 说明 |
|------|------|------|
| 0 | #2d333b | 无阅读 |
| 1 | #404040 | 少量阅读 |
| 2 | #606060 | 中等阅读 |
| 3 | #909090 | 较多阅读 |
| 4 | #c0c0c0 | 大量阅读 |

## 清理数据功能

在设置页面提供"清理所有数据"功能，可一键清除：
- 所有浏览历史记录
- 所有每日阅读统计数据

清理操作会弹出确认对话框，防止误操作。

## 使用说明

1. 在底部导航栏点击"日历"进入热力日历页面
2. 查看统计信息和热力图
3. 点击有颜色的日期方块查看当天阅读的文章
4. 进入"我的" → "设置" → "热力日历设置"自定义配置
5. 如需清理数据，进入"设置" → "清理所有数据"

## 注意事项

1. 每日统计数据与历史记录独立存储，清理时会同时删除
2. 配置项会自动持久化，重启应用后保持用户设置
3. 颜色范围建议根据个人阅读习惯调整，以获得最佳视觉效果
