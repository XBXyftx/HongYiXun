/**
 * Copyright (c) 2025 XBXyftx
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { AppStorageV2, promptAction } from '@kit.ArkUI'
import { DEVICE_TYPES, APP_STORAGE_KEYS, NewsArticle, UserConfigViewModel, logger, LOG_TAG } from 'common'
import { NewsArticleView, favoriteManager, likeManager, colorModManager, NoteEditor } from 'feature'
import { deviceInfo, pasteboard } from '@kit.BasicServicesKit'
import { CircleNavigation, CircleType } from '@abner/circle_navigation'

// èœå•é¡¹ç±»å?
interface MenuItemInfo {
  icon: Resource | string
  activeIcon?: Resource | string
  label: string
  isActive?: boolean
}

@ComponentV2
export struct ArticlePage {
  @Local userConfig: UserConfigViewModel =
    AppStorageV2.connect(UserConfigViewModel, APP_STORAGE_KEYS.USER_CONFIG, () => new UserConfigViewModel())!
  @Local article: NewsArticle = {
    id: '',
    title: '',
    date: '',
    url: '',
    content: []
  }
  @Local deviceType: DEVICE_TYPES =
    deviceInfo.deviceType === DEVICE_TYPES.PHONE ? DEVICE_TYPES.PHONE : DEVICE_TYPES.TABLET
  @Local isFavorite: boolean = false
  @Local isLiked: boolean = false
  @Local menuExpanded: boolean = false
  @Local showNoteEditor: boolean = false
  // å¯æ‹–åŠ¨æµ®åŠ¨çª—å£ç›¸å…³çŠ¶æ€?
  @Local showDraggableEditor: boolean = false
  @Local dragOffsetX: number = 20
  @Local dragOffsetY: number = 60
  @Local dragPositionX: number = 20
  @Local dragPositionY: number = 60
  // å±å¹•å°ºå¯¸ï¼ˆç”¨äºè¾¹ç•Œé™åˆ¶ï¼‰
  @Local screenWidth: number = 360
  @Local screenHeight: number = 780

  /**
   * æ£€æŸ¥æ”¶è—çŠ¶æ€?
   */
  async checkFavoriteStatus(): Promise<void> {
    this.isFavorite = await favoriteManager.isFavorite(this.article.id)
  }

  /**
   * æ£€æŸ¥ç‚¹èµçŠ¶æ€?
   */
  async checkLikeStatus(): Promise<void> {
    this.isLiked = await likeManager.isLiked(this.article.id)
  }

  /**
   * åˆ‡æ¢æ”¶è—çŠ¶æ€?
   */
  async toggleFavorite(): Promise<void> {
    if (this.isFavorite) {
      const success = await favoriteManager.removeFavorite(this.article.id)
      if (success) {
        this.isFavorite = false
        try {
          promptAction.openToast({ message: 'å·²å–æ¶ˆæ”¶è—?, duration: 1500 })
        } catch (error) {
          promptAction.openToast({ message: 'å·²å–æ¶ˆæ”¶è—?, duration: 1500 })
        }
      }
    } else {
      const success = await favoriteManager.addFavorite(this.article)
      if (success) {
        this.isFavorite = true
        try {
          promptAction.openToast({ message: 'å·²æ·»åŠ åˆ°æ”¶è—', duration: 1500 })
        } catch (error) {
          promptAction.openToast({ message: 'å·²æ·»åŠ åˆ°æ”¶è—', duration: 1500 })
        }
      } else {
        try {
          promptAction.openToast({ message: 'è¯¥æ–‡ç« å·²åœ¨æ”¶è—ä¸­', duration: 1500 })
        } catch (error) {
          promptAction.openToast({ message: 'è¯¥æ–‡ç« å·²åœ¨æ”¶è—ä¸­', duration: 1500 })
        }
      }
    }
  }

  /**
   * åˆ‡æ¢ç‚¹èµçŠ¶æ€?
   */
  async toggleLike(): Promise<void> {
    if (this.isLiked) {
      const success = await likeManager.removeLike(this.article.id)
      if (success) {
        this.isLiked = false
        promptAction.openToast({ message: 'å·²å–æ¶ˆç‚¹èµ?, duration: 1500 })
      }
    } else {
      const success = await likeManager.addLike(this.article)
      if (success) {
        this.isLiked = true
        promptAction.openToast({ message: 'å·²ç‚¹èµ?, duration: 1500 })
      } else {
        promptAction.openToast({ message: 'è¯¥æ–‡ç« å·²ç‚¹èµ', duration: 1500 })
      }
    }
  }

  /**
   * åˆ†äº«æ–‡ç«  - å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
   */
  shareArticle(): void {
    const shareText = `ã€?{this.article.title}ã€‘\n${this.article.url}\n\næ¥è‡ªé¸¿æ˜“è®¯`
    logger.info(`${LOG_TAG.MAIN_PAGE}åˆ†äº«æ–‡ç« : ${this.article.title}`)

    try {
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, shareText)
      const systemPasteboard = pasteboard.getSystemPasteboard()

      systemPasteboard.setData(pasteData).then(() => {
        logger.info(`${LOG_TAG.MAIN_PAGE}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`)
        promptAction.openToast({ message: 'é“¾æ¥å·²å¤åˆ¶ï¼Œå¯ç²˜è´´åˆ†äº?, duration: 2000 })
      }).catch((err: Error) => {
        logger.error(`${LOG_TAG.MAIN_PAGE}å¤åˆ¶å¤±è´¥: ${err.message}`)
        promptAction.openToast({ message: 'å¤åˆ¶å¤±è´¥', duration: 1500 })
      })
    } catch (error) {
      logger.error(`${LOG_TAG.MAIN_PAGE}åˆ†äº«å¤±è´¥: ${JSON.stringify(error)}`)
      promptAction.openToast({ message: 'åˆ†äº«å¤±è´¥', duration: 1500 })
    }
  }

  /**
   * è·å–èœå•é¡¹é…ç½?
   */
  getMenuItems(): MenuItemInfo[] {
    return [
      {
        icon: $rawfile('note_icon.svg'),
        label: 'ç¬”è®°',
        isActive: false
      },
      {
        icon: $rawfile('color_mode.svg'),
        label: 'æ·±æµ…è‰?,
        isActive: false
      },
      {
        icon: $rawfile('font_size.svg'),
        label: 'å­—å·',
        isActive: false
      },
      {
        icon: this.isLiked ? $rawfile('like_filled.svg') : $rawfile('like_outline.svg'),
        label: 'ç‚¹èµ',
        isActive: this.isLiked
      },
      {
        icon: this.isFavorite ? $rawfile('favorite_filled.svg') : $rawfile('favorite_outline.svg'),
        label: 'æ”¶è—',
        isActive: this.isFavorite
      },
      {
        icon: $rawfile('share_icon.svg'),
        label: 'åˆ†äº«',
        isActive: false
      }
    ]
  }

  /**
   * å¤„ç†èœå•é¡¹ç‚¹å‡?
   */
  handleMenuClick(position: number): void {
    switch (position) {
      case 0: // ç¬”è®°
        this.openNoteEditor()
        break
      case 1: // æ·±æµ…è‰²åˆ‡æ?
        this.toggleColorMode()
        break
      case 2: // å­—å·è°ƒæ•´
        this.showFontSizeSheet()
        break
      case 3: // ç‚¹èµ
        this.toggleLike()
        break
      case 4: // æ”¶è—
        this.toggleFavorite()
        break
      case 5: // åˆ†äº«
        this.shareArticle()
        break
    }
    // ç‚¹å‡»åæ”¶èµ·èœå?
    this.menuExpanded = false
  }

  /**
   * æ‰“å¼€ç¬”è®°ç¼–è¾‘å™?
   */
  openNoteEditor(): void {
    // å¦‚æœæ˜¯è·Ÿæ‰‹å¼¹çª—æ¨¡å¼ï¼ˆå€¼ä¸º2ï¼‰ï¼Œä½¿ç”¨è‡ªå®šä¹‰å¯æ‹–åŠ¨çª—å£
    if (this.userConfig.noteEditorSheetType === 2) {
      this.showDraggableEditor = true
    } else {
      this.showNoteEditor = true
    }
  }

  /**
   * é™åˆ¶æ‹–åŠ¨ä½ç½®åœ¨å±å¹•è¾¹ç•Œå†…
   */
  clampDragPosition(x: number, y: number): void {
    const windowWidth = this.deviceType === DEVICE_TYPES.PHONE ? this.screenWidth * 0.9 : this.screenWidth * 0.5
    const windowHeight = this.screenHeight * 0.75

    const minX = -windowWidth + 60
    const maxX = this.screenWidth - 60
    const minY = 0
    const maxY = this.screenHeight - 100

    this.dragOffsetX = Math.max(minX, Math.min(maxX, x))
    this.dragOffsetY = Math.max(minY, Math.min(maxY, y))
  }

  /**
   * åˆ‡æ¢æ·±æµ…è‰²æ¨¡å¼?
   */
  toggleColorMode(): void {
    // 0=æµ…è‰², 1=æ·±è‰², 2=è·Ÿéšç³»ç»Ÿï¼Œåœ¨æµ…è‰²å’Œæ·±è‰²ä¹‹é—´åˆ‡æ?
    if (this.userConfig.colorModel === 1) {
      this.userConfig.colorModel = 0
      colorModManager.setLightMod()
      promptAction.openToast({ message: 'å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼', duration: 1500 })
    } else {
      this.userConfig.colorModel = 1
      colorModManager.setDarkMod()
      promptAction.openToast({ message: 'å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼', duration: 1500 })
    }
  }

  /**
   * æ˜¾ç¤ºå­—å·è°ƒæ•´é¢æ¿
   */
  showFontSizeSheet(): void {
    this.getUIContext().getPromptAction().openCustomDialog({
      builder: () => {
        this.FontSizeDialogBuilder()
      }
    })
  }

  @Builder
  FontSizeDialogBuilder() {
    Column({ space: 16 }) {
      Text('è°ƒæ•´å­—å·')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))

      Row() {
        Text('A')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
        Slider({
          value: this.userConfig.fontSize,
          min: 14,
          max: 24,
          step: 2
        })
          .layoutWeight(1)
          .onChange((value: number) => {
            this.userConfig.fontSize = value
          })
        Text('A')
          .fontSize(24)
          .fontColor($r('app.color.text_secondary'))
      }
      .width('100%')

      Text(`å½“å‰å­—å·: ${this.userConfig.fontSize}`)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
    }
    .padding(24)
    .backgroundColor($r('app.color.card_bg'))
    .borderRadius(16)
    .width('80%')
  }

  @Builder
  ArticleContentBuilder() {
    Column() {
      Column() {
        NewsArticleView({ article: this.article, baseFontSize: this.userConfig.fontSize })
          .width('100%')
      }
      .width(this.deviceType === DEVICE_TYPES.PHONE ? '100%' : '90%')
      .height('100%')
    }
    .width('100%')
  }

  /**
   * åœ†å½¢å¯¼èˆªä¸»æŒ‰é’?
   */
  @Builder
  menuTriggerBuilder() {
    Stack({ alignContent: Alignment.Center }) {
      Image(this.menuExpanded ? $rawfile('close.svg') : $rawfile('settings_icon.svg'))
        .width('50%')
        .height('50%')
        .fillColor($r('app.color.color_change_button_font'))
    }
    .width(this.deviceType === DEVICE_TYPES.PHONE ? 50 : 60)
    .height(this.deviceType === DEVICE_TYPES.PHONE ? 50 : 60)
    .backgroundColor($r('app.color.color_change_button_background'))
    .borderRadius(99)
    .shadow({ color: Color.Black, radius: 15, offsetY: 4 })
    .onClick(() => {
      this.menuExpanded = !this.menuExpanded
    })
  }

  /**
   * åœ†å½¢å¯¼èˆªå­èœå•é¡¹
   */
  @Builder
  menuItemBuilder(position: number) {
    Column() {
      Stack({ alignContent: Alignment.Center }) {
        Image(this.getMenuItems()[position].icon)
          .width('50%')
          .height('50%')
          .fillColor(this.getMenuItemColor(position))
      }
      .width(this.deviceType === DEVICE_TYPES.PHONE ? 40 : 48)
      .height(this.deviceType === DEVICE_TYPES.PHONE ? 40 : 48)
      .backgroundColor($r('app.color.color_change_button_background'))
      .borderRadius(99)
      .shadow({ color: Color.Black, radius: 8, offsetY: 2 })
      .onClick(() => {
        this.handleMenuClick(position)
      })
    }
  }

  /**
   * è·å–èœå•é¡¹é¢œè‰?
   */
  getMenuItemColor(position: number): ResourceColor {
    if (position === 0) {
      return '#FF9500' // ç¬”è®°æ©™è‰²
    }
    if (position === 3 && this.isLiked) {
      return '#FFD700' // ç‚¹èµæ¿€æ´»è‰²
    }
    if (position === 4 && this.isFavorite) {
      return '#FF0000' // æ”¶è—æ¿€æ´»è‰²
    }
    return $r('app.color.color_change_button_font')
  }

  @Builder
  NoteEditorSheetBuilder() {
    NoteEditor({
      note: null,
      initialArticle: this.article,
      onClose: () => {
        this.showNoteEditor = false
      },
      onSaved: () => {
        promptAction.openToast({ message: 'ç¬”è®°å·²ä¿å­?, duration: 1500 })
      }
    })
  }

  /**
   * å¯æ‹–åŠ¨æµ®åŠ¨ç¬”è®°ç¼–è¾‘å™¨
   */
  @Builder
  DraggableNoteEditorBuilder() {
    Column() {
      // æ‹–åŠ¨æ‰‹æŸ„åŒºåŸŸ
      Row() {
        Row() {
          Image($rawfile('drag_handle.svg'))
            .width(20)
            .height(20)
            .fillColor($r('app.color.text_secondary'))
          Text('æ‹–åŠ¨ç§»åŠ¨çª—å£')
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 8 })
        }
        .layoutWeight(1)

        Image($rawfile('close.svg'))
          .width(24)
          .height(24)
          .fillColor($r('app.color.text_primary'))
          .onClick(() => {
            this.showDraggableEditor = false
          })
      }
      .width('100%')
      .height(40)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.card_bg'))
      .borderRadius({ topLeft: 16, topRight: 16 })

      // ç¬”è®°ç¼–è¾‘å™¨å†…å®?
      NoteEditor({
        note: null,
        initialArticle: this.article,
        onClose: () => {
          this.showDraggableEditor = false
        },
        onSaved: () => {
          promptAction.openToast({ message: 'ç¬”è®°å·²ä¿å­?, duration: 1500 })
        }
      })
    }
    .width(this.deviceType === DEVICE_TYPES.PHONE ? '90%' : '50%')
    .height('75%')
    .backgroundColor($r('app.color.page_background'))
    .borderRadius(16)
    .shadow({
      radius: 24,
      color: 'rgba(0, 0, 0, 0.3)',
      offsetX: 0,
      offsetY: 8
    })
    .clip(true)
  }

  build() {
    NavDestination() {
      Stack() {
        this.ArticleContentBuilder()

        // åœ†å½¢å¯¼èˆªèœå• - å³ä¸‹è§?
        CircleNavigation({
          clickStatus: this.menuExpanded,
          quantity: 6,
          radius: this.deviceType === DEVICE_TYPES.PHONE ? 100 : 120,
          circleType: CircleType.LEFT_HALF,
          circleOffset: 0.15,
          duration: 300,
          parentLayout: () => {
            this.menuTriggerBuilder()
          },
          childLayout: (position: number) => {
            this.menuItemBuilder(position)
          }
        })
          .position({
            right: this.deviceType === DEVICE_TYPES.PHONE ? 20 : 30,
            bottom: this.deviceType === DEVICE_TYPES.PHONE ? 100 : 120
          })

        // å¯æ‹–åŠ¨æµ®åŠ¨ç¬”è®°ç¼–è¾‘å™¨
        if (this.showDraggableEditor) {
          // åŠé€æ˜é®ç½©å±?
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0, 0, 0, 0.4)')

          // å¯æ‹–åŠ¨çš„ç¼–è¾‘å™¨çª—å?
          Column() {
            this.DraggableNoteEditorBuilder()
          }
          .translate({ x: this.dragOffsetX, y: this.dragOffsetY })
          .gesture(
            PanGesture()
              .onActionUpdate((event: GestureEvent | undefined) => {
                if (event) {
                  const newX = this.dragPositionX + event.offsetX
                  const newY = this.dragPositionY + event.offsetY
                  this.clampDragPosition(newX, newY)
                }
              })
              .onActionEnd(() => {
                this.dragPositionX = this.dragOffsetX
                this.dragPositionY = this.dragOffsetY
              })
          )
        }
      }
      .onAreaChange((_oldValue: Area, newValue: Area) => {
        this.screenWidth = newValue.width as number
        this.screenHeight = newValue.height as number
      })
    }
    .hideTitleBar(true)
    .hideBackButton(true)
    .hideToolBar(true)
    .borderRadius(8)
    .onReady((navDestinationContext: NavDestinationContext) => {
      this.article = navDestinationContext.pathInfo.param as NewsArticle
      this.checkFavoriteStatus()
      this.checkLikeStatus()
    })
    .width('100%')
    .height('100%')
    .bindSheet(
      $this.showNoteEditor,
      this.NoteEditorSheetBuilder(),
      {
        height: '100%',
        width: this.deviceType === DEVICE_TYPES.PHONE ? '95%' : '50%',
        dragBar: false,
        showClose: false,
        backgroundColor: $r('app.color.page_background'),
        preferType: this.userConfig.noteEditorSheetType as SheetType
      }
    )
  }
}