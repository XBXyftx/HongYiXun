/**
 * Copyright (c) 2025 XBXyftx
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { AbilityConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { AppStorageV2, window } from '@kit.ArkUI';
import { appInit } from '../init/AppInit';
import { userConfigManager } from 'feature';
import { APP_STORAGE_KEYS, WinWidth, logger, LOG_TAG } from 'common';

/**
 * æ—¥å¿—åŸŸæ ‡è¯†
 * 
 * ç”¨äº hilog æ—¥å¿—è¾“å‡ºï¼Œæ ‡è¯†æ—¥å¿—æ¥æº
 */
const DOMAIN = 0x0000;

/**
 * hilog æ—¥å¿—æ ‡ç­¾
 * 
 * ç”¨äºè¿‡æ»¤å’Œæœç´¢æ—¥å¿—
 */
const TAG = 'EntryAbility';

/**
 * åº”ç”¨å…¥å£ Ability
 * 
 * ä½œä¸ºåº”ç”¨çš„ä¸»å…¥å£ï¼Œè´Ÿè´£ï¼š
 * - åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
 * - åº”ç”¨åˆå§‹åŒ–æµç¨‹åè°ƒ
 * - çª—å£åˆ›å»ºå’Œé¡µé¢åŠ è½½
 * - å…¨å±€çŠ¶æ€ç®¡ç†
 * 
 * @remarks
 * ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è°ƒç”¨é¡ºåºï¼š
 * 1. onCreate(): åº”ç”¨åˆ›å»ºæ—¶è°ƒç”¨ï¼Œè¿›è¡ŒåŸºç¡€åˆå§‹åŒ–
 * 2. onWindowStageCreate(): çª—å£åˆ›å»ºæ—¶è°ƒç”¨ï¼Œåˆå§‹åŒ– UI ç›¸å…³æ¨¡å—
 * 3. onForeground(): åº”ç”¨è¿›å…¥å‰å°
 * 4. onBackground(): åº”ç”¨è¿›å…¥åå°ï¼Œä¿å­˜æ•°æ®
 * 5. onWindowStageDestroy(): çª—å£é”€æ¯
 * 6. onDestroy(): åº”ç”¨é”€æ¯
 * 
 * åˆå§‹åŒ–ç­–ç•¥ï¼š
 * - åˆ†é˜¶æ®µåˆå§‹åŒ–ï¼šåŸºç¡€æ¨¡å— â†’ çª—å£æ¨¡å— â†’ UI ä¾èµ–æ¨¡å—
 * - å¼‚æ­¥å¤„ç†ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹
 * - é”™è¯¯å®¹é”™ï¼šå…³é”®æ¨¡å—å¤±è´¥æ—¶æœ‰é™çº§æ–¹æ¡ˆ
 * 
 * @see AppInit åº”ç”¨åˆå§‹åŒ–ç®¡ç†å™¨
 */
export default class EntryAbility extends UIAbility {
  /**
   * é˜¶æ®µ 1 åˆå§‹åŒ– Promise
   * 
   * ç”¨äºåœ¨çª—å£åˆ›å»ºæ—¶ç­‰å¾…é˜¶æ®µ 1 å®Œæˆï¼Œç¡®ä¿åˆå§‹åŒ–é¡ºåºæ­£ç¡®
   * 
   * @private
   */
  private phase1Promise: Promise<boolean> | null = null
  
  /**
   * åº”ç”¨åˆ›å»ºç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼Œæ˜¯åˆå§‹åŒ–çš„ç¬¬ä¸€ä¸ªé˜¶æ®µ
   * 
   * @param want - å¯åŠ¨æ„å›¾ï¼ŒåŒ…å«å¯åŠ¨å‚æ•°
   * @param launchParam - å¯åŠ¨å‚æ•°ï¼ŒåŒ…å«å¯åŠ¨åŸå› ç­‰ä¿¡æ¯
   * 
   * @remarks
   * åˆå§‹åŒ–å†…å®¹ï¼ˆé˜¶æ®µ 1ï¼‰ï¼š
   * - æ•°æ®åº“åˆå§‹åŒ–ï¼ˆKVæ•°æ®åº“ã€åå¥½è®¾ç½®æ•°æ®åº“ï¼‰
   * - ç”¨æˆ·é…ç½®åŠ è½½
   * - ä¸šåŠ¡ç®¡ç†å™¨åˆå§‹åŒ–
   * - æ•°æ®é¢„åŠ è½½
   * 
   * æ³¨æ„äº‹é¡¹ï¼š
   * - æ­¤æ—¶çª—å£è¿˜æœªåˆ›å»ºï¼Œä¸èƒ½è®¿é—® UI
   * - ä¸èƒ½ä½¿ç”¨ AppStorageV2
   * - åº”å¿«é€Ÿå®Œæˆï¼Œé¿å…é˜»å¡å¯åŠ¨
   * 
   * é”™è¯¯å¤„ç†ï¼š
   * - åˆå§‹åŒ–å¤±è´¥ä¼šè®°å½•æ—¥å¿—
   * - å…³é”®æ¨¡å—å¤±è´¥å¯èƒ½å½±å“åº”ç”¨åŠŸèƒ½
   * - éå…³é”®æ¨¡å—å¤±è´¥åº”ç”¨ä»å¯è¿è¡Œ
   */
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    hilog.info(DOMAIN, TAG, '%{public}s', 'Ability onCreate');
    logger.info(`${LOG_TAG.ENTRY_ABILITY}åº”ç”¨å¯åŠ¨ï¼Œå¼€å§‹åˆå§‹åŒ–æµç¨‹`)
    
    // é˜¶æ®µ 1ï¼šåŸºç¡€æ¨¡å—åˆå§‹åŒ–ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¿å­˜ Promise ä¾›åç»­ç­‰å¾…ï¼‰
    this.phase1Promise = appInit.initPhase1_BaseModules(this.context)
  }

  /**
   * åº”ç”¨é”€æ¯ç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * åœ¨åº”ç”¨é€€å‡ºæ—¶è°ƒç”¨ï¼Œè¿›è¡Œèµ„æºæ¸…ç†
   * 
   * @remarks
   * æ¸…ç†å†…å®¹ï¼š
   * - é‡Šæ”¾æ•°æ®åº“è¿æ¥
   * - å–æ¶ˆäº‹ä»¶ç›‘å¬
   * - æ¸…ç†ä¸´æ—¶æ•°æ®
   */
  onDestroy(): void {
    hilog.info(DOMAIN, TAG, '%{public}s', 'Ability onDestroy');
    logger.info(`${LOG_TAG.ENTRY_ABILITY}åº”ç”¨é”€æ¯`)
  }

  /**
   * çª—å£é˜¶æ®µåˆ›å»ºç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * åœ¨çª—å£åˆ›å»ºåè°ƒç”¨ï¼Œæ˜¯åˆå§‹åŒ–çš„ç¬¬äºŒå’Œç¬¬ä¸‰é˜¶æ®µ
   * 
   * @param windowStage - çª—å£èˆå°å¯¹è±¡ï¼Œç”¨äºç®¡ç†çª—å£å’ŒåŠ è½½é¡µé¢
   * 
   * @remarks
   * åˆå§‹åŒ–å†…å®¹ï¼š
   * - ç­‰å¾…é˜¶æ®µ 1 å®Œæˆï¼ˆç¡®ä¿åˆå§‹åŒ–é¡ºåºï¼‰
   * - é˜¶æ®µ 2ï¼šçª—å£ç›¸å…³åˆå§‹åŒ–ï¼ˆé¢œè‰²æ¨¡å¼ç®¡ç†å™¨ç­‰ï¼‰
   * - AppStorageV2 åˆå§‹åŒ–ï¼ˆçª—å£å®½åº¦ï¼‰
   * - é¡µé¢åŠ è½½ï¼ˆStartPageï¼‰
   * - é˜¶æ®µ 3ï¼šUI ä¾èµ–åˆå§‹åŒ–ï¼ˆMarkdown é…ç½®ç­‰ï¼‰
   * 
   * AppStorageV2 åˆå§‹åŒ–æ—¶æœºï¼š
   * - çª—å£åˆ›å»ºåï¼Œé¡µé¢åŠ è½½å‰
   * - å¿…é¡»åœ¨è®¿é—® AppStorageV2 ä¹‹å‰å®Œæˆ
   * 
   * é¡µé¢åŠ è½½ç­–ç•¥ï¼š
   * - é¦–å…ˆåŠ è½½å¯åŠ¨é¡µï¼ˆStartPageï¼‰
   * - å¯åŠ¨é¡µä¼šè‡ªåŠ¨è·³è½¬åˆ°ä¸»é¡µï¼ˆIndexï¼‰
   * - ä½¿ç”¨è·¯ç”±åŠ¨ç”»æå‡ç”¨æˆ·ä½“éªŒ
   */
  onWindowStageCreate(windowStage: window.WindowStage): void {
    hilog.info(DOMAIN, TAG, '%{public}s', 'Ability onWindowStageCreate');
    logger.info(`${LOG_TAG.ENTRY_ABILITY}çª—å£åˆ›å»ºï¼Œç­‰å¾…é˜¶æ®µ 1 å®Œæˆ...`)
    
    // ç­‰å¾…é˜¶æ®µ 1 å®Œæˆï¼ˆå¦‚æœè¿˜åœ¨è¿›è¡Œä¸­ï¼‰
    const phase1Promise = this.phase1Promise || Promise.resolve(false)
    
    phase1Promise.then((phase1Success) => {
      // è®°å½•é˜¶æ®µ 1 ç»“æœ
      if (phase1Success) {
        logger.info(`${LOG_TAG.ENTRY_ABILITY}âœ“ é˜¶æ®µ 1 åˆå§‹åŒ–æˆåŠŸ`)
      } else {
        logger.error(`${LOG_TAG.ENTRY_ABILITY}âœ— é˜¶æ®µ 1 åˆå§‹åŒ–å¤±è´¥ï¼Œåº”ç”¨å¯èƒ½æ— æ³•æ­£å¸¸è¿è¡Œ`)
      }
      
      // é˜¶æ®µ 2ï¼šçª—å£ç›¸å…³æ¨¡å—åˆå§‹åŒ–
      logger.info(`${LOG_TAG.ENTRY_ABILITY}å¼€å§‹é˜¶æ®µ 2 åˆå§‹åŒ–...`)
      const phase2Success = appInit.initPhase2_WindowRelated(this.context.getApplicationContext())
      if (phase2Success) {
        logger.info(`${LOG_TAG.ENTRY_ABILITY}âœ“ é˜¶æ®µ 2 åˆå§‹åŒ–æˆåŠŸ`)
      } else {
        logger.warn(`${LOG_TAG.ENTRY_ABILITY}âš  é˜¶æ®µ 2 åˆå§‹åŒ–å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—å½±å“`)
      }
      
      // åˆå§‹åŒ– AppStorageV2ï¼šå­˜å‚¨çª—å£å®½åº¦
      window.getLastWindow(this.context).then((win) => {
        const winWidth = win.getWindowProperties().windowRect.width
        AppStorageV2.connect(WinWidth, APP_STORAGE_KEYS.WINDOW_WIDTH, () => new WinWidth(winWidth))
        logger.info(`${LOG_TAG.ENTRY_ABILITY}çª—å£å®½åº¦å·²å­˜å‚¨åˆ° AppStorageV2: ${winWidth}px`)
      }).catch((error: Error) => {
        logger.error(`${LOG_TAG.ENTRY_ABILITY}è·å–çª—å£å®½åº¦å¤±è´¥: ${JSON.stringify(error)}`)
      })
      
      // åŠ è½½å¯åŠ¨é¡µé¢
      windowStage.loadContent('pages/StartPage', (err) => {
        if (err.code) {
          hilog.error(DOMAIN, TAG, 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
          logger.error(`${LOG_TAG.ENTRY_ABILITY}é¡µé¢åŠ è½½å¤±è´¥: ${JSON.stringify(err)}`)
          return;
        }
        
        hilog.info(DOMAIN, TAG, 'Succeeded in loading the content.');
        logger.info(`${LOG_TAG.ENTRY_ABILITY}å¯åŠ¨é¡µåŠ è½½æˆåŠŸ`)
        
        // é˜¶æ®µ 3ï¼šUI ä¾èµ–æ¨¡å—åˆå§‹åŒ–
        logger.info(`${LOG_TAG.ENTRY_ABILITY}å¼€å§‹é˜¶æ®µ 3 åˆå§‹åŒ–...`)
        const phase3Success = appInit.initPhase3_UIDependent()
        if (phase3Success) {
          logger.info(`${LOG_TAG.ENTRY_ABILITY}âœ“ é˜¶æ®µ 3 åˆå§‹åŒ–æˆåŠŸ`)
        } else {
          logger.warn(`${LOG_TAG.ENTRY_ABILITY}âš  é˜¶æ®µ 3 åˆå§‹åŒ–å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—å½±å“`)
        }
        
        // ç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆåï¼Œæ‰“å°æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
        setTimeout(() => {
          this.printFinalInitStatus()
        }, 100) // ç»™å¼‚æ­¥æ“ä½œç•™å‡ºå®Œæˆæ—¶é—´
      });
    }).catch((error: Error) => {
      logger.error(`${LOG_TAG.ENTRY_ABILITY}âœ— é˜¶æ®µ 1 åˆå§‹åŒ–å¼‚å¸¸: ${JSON.stringify(error)}`)
      logger.error(`${LOG_TAG.ENTRY_ABILITY}åº”ç”¨å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡å¯åº”ç”¨`)
    })
  }
  
  /**
   * æ‰“å°æœ€ç»ˆåˆå§‹åŒ–çŠ¶æ€æŠ¥å‘Š
   * 
   * åœ¨æ‰€æœ‰åˆå§‹åŒ–é˜¶æ®µå®Œæˆåè°ƒç”¨ï¼Œè¾“å‡ºå®Œæ•´çš„çŠ¶æ€æŠ¥å‘Š
   * 
   * @private
   */
  private printFinalInitStatus(): void {
    logger.info(`${LOG_TAG.ENTRY_ABILITY}========================================`)
    logger.info(`${LOG_TAG.ENTRY_ABILITY}      åº”ç”¨åˆå§‹åŒ–å®ŒæˆçŠ¶æ€æŠ¥å‘Š`)
    logger.info(`${LOG_TAG.ENTRY_ABILITY}========================================`)
    
    // æ‰“å°è¯¦ç»†çŠ¶æ€
    appInit.printInitStatus()
    
    // æ£€æŸ¥å®Œæ•´åˆå§‹åŒ–çŠ¶æ€
    if (appInit.isFullyInitialized()) {
      logger.info(`${LOG_TAG.ENTRY_ABILITY}`)
      logger.info(`${LOG_TAG.ENTRY_ABILITY}ğŸ‰ åº”ç”¨å®Œå…¨åˆå§‹åŒ–æˆåŠŸï¼Œæ‰€æœ‰åŠŸèƒ½å¯ç”¨`)
      logger.info(`${LOG_TAG.ENTRY_ABILITY}`)
    } else {
      logger.warn(`${LOG_TAG.ENTRY_ABILITY}`)
      logger.warn(`${LOG_TAG.ENTRY_ABILITY}âš ï¸  åº”ç”¨åˆå§‹åŒ–ä¸å®Œæ•´ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™`)
      const status = appInit.getInitStatus()
      logger.warn(`${LOG_TAG.ENTRY_ABILITY}è¯¦ç»†çŠ¶æ€: ${JSON.stringify(status)}`)
      logger.warn(`${LOG_TAG.ENTRY_ABILITY}`)
    }
    
    logger.info(`${LOG_TAG.ENTRY_ABILITY}========================================`)
  }

  /**
   * çª—å£é˜¶æ®µé”€æ¯ç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * åœ¨çª—å£é”€æ¯æ—¶è°ƒç”¨ï¼Œé‡Šæ”¾ UI ç›¸å…³èµ„æº
   * 
   * @remarks
   * æ¸…ç†å†…å®¹ï¼š
   * - é‡Šæ”¾ UI èµ„æº
   * - å–æ¶ˆçª—å£ç›‘å¬
   * - æ¸…ç†ä¸´æ—¶ UI çŠ¶æ€
   */
  onWindowStageDestroy(): void {
    hilog.info(DOMAIN, TAG, '%{public}s', 'Ability onWindowStageDestroy');
    logger.info(`${LOG_TAG.ENTRY_ABILITY}çª—å£é”€æ¯`)
  }

  /**
   * åº”ç”¨è¿›å…¥å‰å°ç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * å½“åº”ç”¨ä»åå°åˆ‡æ¢åˆ°å‰å°æ—¶è°ƒç”¨
   * 
   * @remarks
   * å¯èƒ½çš„æ“ä½œï¼š
   * - åˆ·æ–°æ•°æ®ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
   * - æ¢å¤çŠ¶æ€ï¼šæ¢å¤ç”¨æˆ·æ“ä½œçŠ¶æ€
   * - é‡æ–°è¿æ¥ï¼šé‡æ–°å»ºç«‹ç½‘ç»œè¿æ¥
   */
  onForeground(): void {
    hilog.info(DOMAIN, TAG, '%{public}s', 'Ability onForeground');
    logger.info(`${LOG_TAG.ENTRY_ABILITY}åº”ç”¨è¿›å…¥å‰å°`)
  }

  /**
   * åº”ç”¨è¿›å…¥åå°ç”Ÿå‘½å‘¨æœŸå›è°ƒ
   * 
   * å½“åº”ç”¨ä»å‰å°åˆ‡æ¢åˆ°åå°æ—¶è°ƒç”¨
   * 
   * @remarks
   * æ•°æ®ä¿å­˜ï¼š
   * - è‡ªåŠ¨ä¿å­˜ç”¨æˆ·é…ç½®åˆ°æŒä¹…åŒ–å­˜å‚¨
   * - ç¡®ä¿ç”¨æˆ·æ•°æ®ä¸ä¸¢å¤±
   * - ä¸ºä¸‹æ¬¡å¯åŠ¨åšå‡†å¤‡
   * 
   * ä¿å­˜å†…å®¹ï¼š
   * - ç”¨æˆ·å­—ä½“å¤§å°è®¾ç½®
   * - ç”¨æˆ·é¢œè‰²æ¨¡å¼åå¥½
   * - å…¶ä»–ç”¨æˆ·é…ç½®é¡¹
   * 
   * æ‰§è¡Œæ—¶æœºï¼š
   * - ç”¨æˆ·æŒ‰Homeé”®é€€å‡º
   * - åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨
   * - ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶è¢«æŒ‚èµ·
   */
  onBackground(): void {
    hilog.info(DOMAIN, TAG, '%{public}s', 'Ability onBackground');
    logger.info(`${LOG_TAG.ENTRY_ABILITY}åº”ç”¨è¿›å…¥åå°ï¼Œå¼€å§‹ä¿å­˜ç”¨æˆ·æ•°æ®`)
    
    // åŒæ­¥ç”¨æˆ·é…ç½®åˆ°æŒä¹…åŒ–å­˜å‚¨
    const syncSuccess = userConfigManager.syncDataToPreference()
    if (syncSuccess) {
      logger.info(`${LOG_TAG.ENTRY_ABILITY}ç”¨æˆ·é…ç½®ä¿å­˜æˆåŠŸ`)
    } else {
      logger.error(`${LOG_TAG.ENTRY_ABILITY}ç”¨æˆ·é…ç½®ä¿å­˜å¤±è´¥ï¼Œè®¾ç½®å¯èƒ½ä¸¢å¤±`)
    }
  }
}
